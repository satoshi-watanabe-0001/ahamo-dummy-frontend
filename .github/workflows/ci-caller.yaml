name: CI Pipeline

on:
  push:
    branches:
      - dev
      - test
      - feature/*
      - 'devin/**'
    tags:
      - 'prod-*'
      - 'dev-*'
      - 'test-*'
  pull_request:
    branches:
      - main
      - dev
      - test

env:
  ENV: ${{ github.ref_name == 'dev' && 'dev' || github.ref_name == 'test' && 'test' || startsWith(github.ref, 'refs/tags/prod-') && 'prod' || 'dev' }}

jobs:
  ci-init:
    name: åˆæœŸåŒ–
    runs-on: ubuntu-latest
    outputs:
      ENV_TYPE: ${{ steps.set-env.outputs.ENV_TYPE }}
      ENVIRONMENT: ${{ steps.set-env.outputs.ENVIRONMENT }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: ç’°å¢ƒå¤‰æ•°è¨­å®š
        id: set-env
        run: |
          if [[ "${{ env.ENV }}" == "prod" ]]; then
            echo "ENV_TYPE=prod" >> $GITHUB_OUTPUT
            echo "ENVIRONMENT=production" >> $GITHUB_OUTPUT
          else
            echo "ENV_TYPE=nprd" >> $GITHUB_OUTPUT
            echo "ENVIRONMENT=development" >> $GITHUB_OUTPUT
          fi
          echo "ğŸ”§ ç’°å¢ƒè¨­å®šå®Œäº†: ENV=${{ env.ENV }}, ENV_TYPE=$(echo $ENV_TYPE), ENVIRONMENT=$(echo $ENVIRONMENT)"

  ci-test:
    name: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    runs-on: ubuntu-latest
    needs: ci-init
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        run: |
          chmod +x .github/scripts/test.sh
          ./.github/scripts/test.sh

  ci-build:
    name: ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
    runs-on: ubuntu-latest
    needs: ci-init
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
        run: |
          chmod +x .github/scripts/copy.sh
          ./.github/scripts/copy.sh
          
      - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: dist/
